"""奇门遁甲 AI 解读 Prompt 模板"""


def build_qimen_prompt(chart, divination_topic: str = "") -> str:
    """构建奇门遁甲解读的 Prompt"""

    # 九宫信息
    palace_text = ""
    layout_order = [4, 9, 2, 3, 5, 7, 8, 1, 6]
    for num in layout_order:
        p = chart.palaces[num]
        flag = ""
        if p.is_zhifu:
            flag = "（值符值使所在宫）"
        palace_text += (
            f"  {num}宫({p.name},{p.direction}): "
            f"天盘={p.tianpan} 地盘={p.dipan} | "
            f"九星={p.star} 八门={p.door} 八神={p.god}"
            f"{flag}\n"
        )

    # 占卜事项部分
    topic_section = ""
    topic_analysis = ""
    if divination_topic.strip():
        topic_section = f"\n【占卜事项】\n{divination_topic}\n"
        topic_analysis = f"""

6.【事项专断】
  → 思路：①确定此事的用神宫位（如求财看生门、求官看开门、求婚看六合/太阴等）；②分析用神宫的天地盘干组合、星门神搭配是否有利；③看用神宫与日干落宫的关系（生克比和）；④有无凶格（伏吟、反吟、入墓、击刑、门迫等）影响此事。
  → 结论：针对「{divination_topic}」给出明确判断——可为还是不可为、时机是否成熟、需注意什么、如何趋吉避凶。"""

    prompt = f"""你是一位精通奇门遁甲的分析师，擅长用现代语言解读古法术数，语风稳重务实。

【起局信息】
公历：{chart.solar_year}年{chart.solar_month}月{chart.solar_day}日 {chart.solar_hour}时
四柱：{chart.year_gz}年 {chart.month_gz}月 {chart.day_gz}日 {chart.hour_gz}时
节气：{chart.jieqi_name}（{chart.yuan}元）
局数：{chart.dun_type}遁第{chart.ju_number}局

值符：{chart.zhifu_star}（落{chart.zhifu_palace}宫）
值使：{chart.zhishi_door}（落{chart.zhishi_palace}宫）
{topic_section}
【九宫布局】
{palace_text}

【解读要求】
这是一份用于学习的奇门盘局分析。请在每个分析点中，先展示你的"推理过程"（即你是怎样一步步从盘面信息得出结论的），再给出结论。
请使用以下格式：
  → 思路：列出你观察到的关键盘面信息、采用的分析方法、推理的每一步
  → 结论：基于上述推理得出的判断

请从以下几个维度进行分析（约700-1000字）：

1.【整体格局】
  → 思路：①看值符（九星之首）落在哪宫，旺相休囚如何；②看值使（八门之首）落宫状态；③看值符值使与日干的生克关系；④有无伏吟、反吟等特殊格局。
  → 结论：当前盘面总体吉凶趋势。

2.【事业求财】
  → 思路：①找开门（事业）和生门（求财）所在宫位；②分析该宫的天盘干+地盘干组合是什么格（如丙+戊是青龙返首等）；③看该宫的九星是吉星还是凶星；④看该宫天地盘干与日干的生克关系。
  → 结论：事业财运判断。

3.【出行方位】
  → 思路：①找各宫的吉凶格局——吉格（青龙返首、飞鸟跌穴等）在哪个方位；②凶格（庚+庚、庚+癸等）在哪个方位要回避；③看有无门迫（克门之宫）、入墓、击刑等不利因素；④结合日干落宫判断哪个方向与日干相生有利。
  → 结论：利好方位和需回避方位。

4.【人际感情】
  → 思路：①找六合、太阴所在宫位（利人际合作、利隐私感情的方位）；②看该宫的天地盘组合和星门神搭配；③日干落宫与配偶/合作方所在宫的生克关系。
  → 结论：人际感情判断。

5.【注意事项】
  → 思路：①逐宫检查有无凶格（如庚+庚太白逢星、庚+癸大格等）；②有无天网四张、地网高张等特殊格局；③值符值使有无受克、入墓等不利状态。
  → 结论：需要注意和提防的事项，以及化解建议。{topic_analysis}

格式要求：每个分析点务必先写"→ 思路"再写"→ 结论"，让学习者能看懂推理链路。语言专业但易懂，不堆砌术语，注重实用性。

最后，请在所有分析点之后，写一段【综述寄语】（150-250字）：
将上述各点结论融汇为一段连贯、温暖而严谨的文字。不要逐条重复，而是用自然流畅的叙事语言，把整体格局、事业财运、方位吉凶、人际感情、注意事项等内容编织成一段完整的当下态势描述。语气要给人以希望和力量，但不夸大、不虚假，基于盘面事实说话。
"""
    return prompt


QIMEN_SYSTEM_PROMPT = "你是一位精通奇门遁甲的预测分析师，基于张志春《神奇之门》体系，擅长用现代语言解读奇门盘局。你的分析严谨但不晦涩，注重给出实用建议。"
